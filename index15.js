import{L as C,d as x,i as I,N as L,s as D,T as u,a as f,b as U,l as j,P as E,g as d,c as V,t as M,e as w}from"./codemirror.js";import"./vendor.js";import"./props.js";import"./index.js";function S(a,t,e,i=0,s=0){t==null&&(t=a.search(/[^\s\u00a0]/),t==-1&&(t=a.length));let n=s;for(let r=i;r<t;r++)a.charCodeAt(r)==9?n+=e-n%e:n++;return n}class y{constructor(t,e,i){this.string=t,this.tabSize=e,this.indentUnit=i,this.pos=0,this.start=0,this.lastColumnPos=0,this.lastColumnValue=0}eol(){return this.pos>=this.string.length}sol(){return this.pos==0}peek(){return this.string.charAt(this.pos)||void 0}next(){if(this.pos<this.string.length)return this.string.charAt(this.pos++)}eat(t){let e=this.string.charAt(this.pos),i;if(typeof t=="string"?i=e==t:i=e&&(t instanceof RegExp?t.test(e):t(e)),i)return++this.pos,e}eatWhile(t){let e=this.pos;for(;this.eat(t););return this.pos>e}eatSpace(){let t=this.pos;for(;/[\s\u00a0]/.test(this.string.charAt(this.pos));)++this.pos;return this.pos>t}skipToEnd(){this.pos=this.string.length}skipTo(t){let e=this.string.indexOf(t,this.pos);if(e>-1)return this.pos=e,!0}backUp(t){this.pos-=t}column(){return this.lastColumnPos<this.start&&(this.lastColumnValue=S(this.string,this.start,this.tabSize,this.lastColumnPos,this.lastColumnValue),this.lastColumnPos=this.start),this.lastColumnValue}indentation(){return S(this.string,null,this.tabSize)}match(t,e,i){if(typeof t=="string"){let s=r=>i?r.toLowerCase():r,n=this.string.substr(this.pos,t.length);return s(n)==s(t)?(e!==!1&&(this.pos+=t.length),!0):null}else{let s=this.string.slice(this.pos).match(t);return s&&s.index>0?null:(s&&e!==!1&&(this.pos+=s[0].length),s)}}current(){return this.string.slice(this.start,this.pos)}}function O(a){return{token:a.token,blankLine:a.blankLine||(()=>{}),startState:a.startState||(()=>!0),copyState:a.copyState||R,indent:a.indent||(()=>null),languageData:a.languageData||{}}}function R(a){if(typeof a!="object")return a;let t={};for(let e in a){let i=a[e];t[e]=i instanceof Array?i.slice():i}return t}class b extends C{constructor(t){let e=x(t.languageData),i=O(t),s,n=new class extends E{createParse(r,h,l){return new F(s,r,h,l)}};super(e,n,q(e),[I.of((r,h)=>this.getIndent(r,h))]);s=this,this.streamParser=i,this.stateAfter=new L({perNode:!0})}static define(t){return new b(t)}getIndent(t,e){let i=D(t.state),s=i.resolve(e);for(;s&&s.type!=this.topNode;)s=s.parent;if(!s)return null;let n=c(this,i,0,s.from,e),r,h;if(n?(h=n.state,r=n.pos+1):(h=this.streamParser.startState(t.unit),r=0),e-r>1e4)return null;for(;r<e;){let o=t.state.doc.lineAt(r),m=Math.min(e,o.to);if(o.length){let P=new y(o.text,t.state.tabSize,t.unit);for(;P.pos<m-o.from;)A(this.streamParser.token,P,h)}else this.streamParser.blankLine(h,t.unit);if(m==e)break;r=o.to+1}let{text:l}=t.state.doc.lineAt(e);return this.streamParser.indent(h,/^\s*(.*)/.exec(l)[1],t)}get allowsNesting(){return!1}}function c(a,t,e,i,s){let n=e>=i&&e+t.length<=s&&t.prop(a.stateAfter);if(n)return{state:a.streamParser.copyState(n),pos:e+t.length};for(let r=t.children.length-1;r>=0;r--){let h=t.children[r],l=e+t.positions[r],o=h instanceof u&&l<s&&c(a,h,l,i,s);if(o)return o}return null}function v(a,t,e,i,s){if(s&&e<=0&&i>=t.length)return t;!s&&t.type==a.topNode&&(s=!0);for(let n=t.children.length-1;n>=0;n--){let r=t.positions[n]+e,h=t.children[n],l;if(r<i&&h instanceof u){if(!(l=v(a,h,e-r,i-r,s)))break;return s?new u(t.type,t.children.slice(0,n).concat(l),t.positions.slice(0,n+1),r+l.length):l}}return null}function z(a,t,e,i){for(let s of t){let n=s.from+(s.openStart?25:0),r=s.to-(s.openEnd?25:0),h=n<=e&&r>e&&c(a,s.tree,0-s.offset,e,r),l;if(h&&(l=v(a,s.tree,e+s.offset,h.pos+s.offset,!1)))return{state:h.state,tree:l}}return{state:a.streamParser.startState(i?d(i):4),tree:u.empty}}class F{constructor(t,e,i,s){this.lang=t,this.input=e,this.fragments=i,this.ranges=s,this.stoppedAt=null,this.chunks=[],this.chunkPos=[],this.chunk=[],this.chunkReused=void 0,this.rangeIndex=0,this.to=s[s.length-1].to;let n=w.get(),r=s[0].from,{state:h,tree:l}=z(t,i,r,n==null?void 0:n.state);this.state=h,this.parsedPos=this.chunkStart=r+l.length,l.length&&(this.chunks.push(l),this.chunkPos.push(0)),n&&this.parsedPos<n.viewport.from-1e5&&(this.state=this.lang.streamParser.startState(d(n.state)),n.skipUntilInView(this.parsedPos,n.viewport.from),this.parsedPos=n.viewport.from)}advance(){let t=w.get(),e=this.stoppedAt==null?this.to:this.stoppedAt,i=Math.min(e,this.chunkStart+2048);for(t&&(i=Math.min(i,t.viewport.to));this.parsedPos<i;)this.parseLine(t);return this.chunkStart<this.parsedPos&&this.finishChunk(),this.parsedPos>=e?this.finish():t&&this.parsedPos>t.viewport.to?(t.skipUntilInView(this.parsedPos,e),this.finish()):null}stopAt(t){this.stoppedAt=t}lineAfter(t){let e=this.input.chunk(t);if(this.input.lineChunks)e==`
`&&(e="");else{let i=e.indexOf(`
`);i>-1&&(e=e.slice(0,i))}return t+e.length<=this.to?e:e.slice(0,this.to-t)}nextLine(){let t=this.parsedPos,e=this.lineAfter(t),i=t+e.length;for(let s=this.rangeIndex;;){let n=this.ranges[s].to;if(n>=i||(e=e.slice(0,n-(i-e.length)),s++,s==this.ranges.length))break;let r=this.ranges[s].from,h=this.lineAfter(r);e+=h,i=r+h.length}return{line:e,end:i}}skipGapsTo(t,e,i){for(;;){let s=this.ranges[this.rangeIndex].to,n=t+e;if(i>0?s>n:s>=n)break;e+=this.ranges[++this.rangeIndex].from-s}return e}emitToken(t,e,i,s,n){if(this.ranges.length>1){n=this.skipGapsTo(e,n,1),e+=n;let r=this.chunk.length;n=this.skipGapsTo(i,n,-1),i+=n,s+=this.chunk.length-r}return this.chunk.push(t,e,i,s),n}parseLine(t){let{line:e,end:i}=this.nextLine(),s=0,{streamParser:n}=this.lang,r=new y(e,t?t.state.tabSize:4,t?d(t.state):2);if(r.eol())n.blankLine(this.state,r.indentUnit);else for(;!r.eol();){let h=A(n.token,r,this.state);h&&(s=this.emitToken(T(h),this.parsedPos+r.start,this.parsedPos+r.pos,4,s))}this.parsedPos=i,this.parsedPos<this.to&&this.parsedPos++}finishChunk(){let t=u.build({buffer:this.chunk,start:this.chunkStart,length:this.parsedPos-this.chunkStart,nodeSet:G,topID:0,maxBufferLength:2048,reused:this.chunkReused});t=new u(t.type,t.children,t.positions,t.length,[[this.lang.stateAfter,this.lang.streamParser.copyState(this.state)]]),this.chunks.push(t),this.chunkPos.push(this.chunkStart-this.ranges[0].from),this.chunk=[],this.chunkReused=void 0,this.chunkStart=this.parsedPos}finish(){return new u(this.lang.topNode,this.chunks,this.chunkPos,this.parsedPos-this.ranges[0].from).balance()}}function A(a,t,e){t.start=t.pos;for(let i=0;i<10;i++){let s=a(t,e);if(t.pos>t.start)return s}throw new Error("Stream parser failed to advance stream.")}const g=Object.create(null),p=[f.none],G=new V(p),N=[];function T(a){return a?g[a]||(g[a]=$(a)):0}for(let[a,t]of[["variable","variableName"],["variable-2","variableName.special"],["string-2","string.special"],["def","variableName.definition"],["tag","typeName"],["attribute","propertyName"],["type","typeName"],["builtin","variableName.standard"],["qualifier","modifier"],["error","invalid"],["header","heading"],["property","propertyName"]])g[a]=T(t);function k(a,t){N.indexOf(a)>-1||(N.push(a),console.warn(t))}function $(a){let t=null;for(let s of a.split(".")){let n=M[s];n?typeof n=="function"?t?t=n(t):k(s,`Modifier ${s} used at start of tag`):t?k(s,`Tag ${s} used as modifier`):t=n:k(s,`Unknown highlighting tag ${s}`)}if(!t)return 0;let e=a.replace(/ /g,"_"),i=f.define({id:p.length,name:e,props:[U({[e]:t})]});return p.push(i),i.id}function q(a){let t=f.define({id:p.length,name:"Document",props:[j.add(()=>a)]});return p.push(t),t}export{b as StreamLanguage,y as StringStream};
